<?php

namespace App\Http\Controllers;

use App\Models\Check;
use App\Models\Director;
use App\Models\Director_PStudent;
use App\Models\Mark;
use App\Models\P_student;
use App\Models\Student;
use App\Models\User;
use App\Models\WeeklyProgram;
use Carbon\Carbon;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;

class DirectorController extends Controller
{
    public function index()
    {
        $user = User::find(1);
        return $user->mobile;

        $director = Director::find(1);
        return $director->user_id;//mobile
    }

    //ุฌูุจ ุฃูููุงุก ุงูุฃููุฑ ููุฏูุฑ:
    public function show()
    {
        //   $director->load('p_Students');     or   p_students::with->("director")
        //    foreach ($director->parentStudents as $parent) {
        //echo $parent->name;
        //      return response()->json($director); // ูุนุฑุถ ุฌููุน ุงููุฑุชุจุทูู ูุน ุงูููุฌู ุจุงูุนูุงูุฉ ุฌููุน ุฃูููุง ุงูุฃููุฑ

        //}
    }
    public function dashboard()
    {
        return view('director.dashboard');
    }

    public function add_mark()
    {
        Mark::create([
            'student_id' => 1,
            'director_id' => 2,
            'class_model_id' => 3,
            'subject_id' => 4,
            'mark' => 95
        ]);
    }

    public function registerParent_student(Request $request): RedirectResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        $validatedData = $request->validate([
            'firstname' => ['required', 'string', 'max:10'],
            'lastname' => ['required', 'string', 'max:10'],
            'son_name' => ['required', 'string'],
            'mobile' => ['required', 'unique:p_students,mobile'],
            'password' => ['required', 'string'],
            'user_id' => ['required'],
            'email' => ['required', 'email'],
        ], [
            'mobile.unique' => "Mobile is not unique",
        ]);

        $user = P_student::query()->create([
            'firstname' => $request['firstname'],
            'lastname' => $request["lastname"],
            'son_name' => $request["son_name"],
            'mobile' => $request['mobile'],
            'password' => bcrypt($request['password']), // ๐ ุชุดููุฑ ุงูุจุงุณูุฑุฏ
            'email' => $request["email"],
            'user_id' => $request['user_id'],
        ]);

        // ุฅุฑุฌุงุน ุงููุณุชุฎุฏู ููุฏุงุดุจูุฑุฏ ูุน ุฑุณุงูุฉ ูุฌุงุญ
        return redirect()->route('director.dashboard')
            ->with('success', "โ ุชู ุชุณุฌูู ููู ุฃูุฑ ุงูุทุงูุจ {$user->firstname} {$user->lastname} ุจูุฌุงุญ!");
    }

    public function registerStudent(Request $request): RedirectResponse | JsonResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }
        $validated =   $request->validate([
            'firstname' => ['required', 'string', 'max:10'],
            'lastname' => ['required', 'string', 'max:10'],
            'address' => ['required', 'string'],
            'parents_job' => ['required', 'string'],
            'parents_name' => ['required', 'string'],
            'date' => ['required', 'date', 'after:2010-01-01', 'before:2020-12-31'],
            'the_class' => ['required', 'string', 'in:first,second,third,fourth,fifth'],
            'mobile' => ['required', 'unique:students,mobile'],
            'password' => ['required'],
            'email' => ['required', 'email'],
            'director_id' => ['required'],
            'user_id' => ['required'],
            'p_student_id' => ['required'],
        ], [
            'mobile.unique' => "ุฑูู ุงูููุจุงูู ููุฌูุฏ ูุณุจูุงู",
        ]);
        $formats = ['Y-m-d', 'd-m-Y', 'd/m/Y'];// ูุฐุง ุจุงูุจูุณุชูุงู ููู ูุง ุจุนุชุช ุงูุชุงุฑูุฎ ููุจูู
        foreach ($formats as $format) {
            try {
                $validated['date'] = Carbon::createFromFormat($format, $validated['date'])->format('Y-m-d');
                break;
            } catch (\Exception $e) {
                // ุชุฌุงูู ูุญุงูู ุจุงูุตูุบุฉ ุงูุชุงููุฉ
            }
        }

        $user = Student::query()->create([
            'firstname' => $request['firstname'],
            'lastname' => $request['lastname'],
            'address' => $request['address'],
            'parents_job' => $request['parents_job'],
            'parents_name' => $request['parents_name'],
            'the_class' => $request['the_class'],
            'date' => $request['date'],
            'mobile' => $request['mobile'],
            'password' => $request['password'],
            'email' => $request['email'],
            'director_id' => $request['director_id'],//ูุง ูุตุญ ุฃู ุชุถุน ุจุงูุฏุงุชุง ุจูุฒ ุฃูุซุฑ ูู ุซูุงุซุฉ ุฅูุง ุฅูุง ุนูุฏู ุจุงูุฏุงุชุง ุจุฒ ุฃูุซุฑ ูู ุซูุงุซุฉ
            'p_student_id' => $request['p_student_id'],// ูุง ูุตุญ ุฃู ุชุถุน ุงูุฌูุงุจ ุฃูุซุฑ ูู ุฎูุณุฉ ุฅูุง ุฅุฐุง ุนูุฏู ุจุงูุฏุงุชุง ุจูุฒ ุฃูุซุฑ ูู ุฎูุณุฉ ุขุจุงุก
            'user_id' => $request['user_id'],
        ]);

        // ุฅุฐุง ุงูุทูุจ ุฌุงู ูู API (Postman)
        if ($request->wantsJson()) {
            return response()////return $request=> usernam ,mobile and password only butreturn  $user =>will come all migrate of model ex: username , mobile  password and id and date
            ->json([
                'status' => 1,
                "date" => $user,
                "message" => "Student created successfuly"
            ]);
        }
        return redirect()->route('director.students.create')->with('success', 'ุชู ุชุณุฌูู ุงูุทุงูุจ ุจูุฌุงุญ โ');

    }

    public function index_students(Request $request): \Illuminate\Contracts\View\Factory|\Illuminate\Contracts\View\View|\Illuminate\Foundation\Application|\Illuminate\Http\JsonResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        $students = Student::all();

        // ุฅุฐุง ุงูุทูุจ ุฌุงู ูู API (Postman)
        if ($request->wantsJson()) {
            return response()->json([
                'success' => true,
                'data' => $students,
                'message' => "The students",
            ]);
        }
        // ุฅุฐุง ุงูุทูุจ ูู ุงูููุจ
        return view('director.students-index', compact('students'));
    }

    public function show_student_details(Request $request, $id)
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        $student = Student::with('marks')->findOrFail($id);

        // ุฅุฐุง API (Postman)
        if ($request->wantsJson()) {
            return response()->json([
                'success' => true,
                'data' => $student,
                'message' => "The details of the student",
            ]);
        }

        // ุฅุฐุง ุงูุทูุจ ูู ุงูููุจ
        return view('director.student-details', compact('student'));
    }

    public function destroy(Request $request, $id): \Illuminate\Http\JsonResponse | \Illuminate\Http\RedirectResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        $student = Student::find($id);

        if (!$student) {
            // API
            if ($request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'ุงูุทุงูุจ ุบูุฑ ููุฌูุฏ'
                ], 404);
            }
            // ููุจ
            return redirect()->route('director.students.index')->with('error', 'ุงูุทุงูุจ ุบูุฑ ููุฌูุฏ โ');
        }
        $student->delete();
        // API
        if ($request->wantsJson()) {
            return response()->json([
                'success' => true,
                'message' => 'ุชู ุญุฐู ุงูุทุงูุจ ุจูุฌุงุญ โ'
            ]);
        }
        // ููุจ
        return redirect()->route('director.students.index')->with('success', 'ุชู ุญุฐู ุงูุทุงูุจ ุจูุฌุงุญ โ');
    }


    // ุฅุถุงูุฉ ุนูุงูุฉ ูุทุงูุจ
    public function addMark(Request $request): JsonResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }
        $request->validate([
            'student_id' => 'required|exists:students,id',
            'subject_id' => 'required|exists:subjects,id',
            'director_id' => 'required|exists:directors,id',
            'the_class_id' => 'required|exists:the_classes,id',
            'mark' => 'required|integer|min:0|max:100',
//            'exam_date'  => 'required|date',
        ]);

        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูุงูุฉ ูุณุจููุง
        $exists = Mark::where('student_id', $request->student_id)
            ->where('subject_id', $request->subject_id)
            ->where('the_class_id', $request->the_class_id)
            ->exists();

        if ($exists) {
            return response()->json([
                'success' => false,
                'message' => 'ุชู ุชุณุฌูู ุนูุงูุฉ ููุฐุง ุงูุทุงูุจ ูู ูุฐู ุงููุงุฏุฉ ููุฐุง ุงูุตู ูู ูุจู.'
            ], 409);
        }

        // ุฅุถุงูุฉ ุงูุนูุงูุฉ ุฅุฐุง ูุง ูุงูุช ููุฌูุฏุฉ

        $mark = Mark::create([
            'student_id' => $request->student_id,
            'subject_id' => $request->subject_id,
            'the_class_id' => $request->the_class_id,
            'director_id' => $request->director_id,
            'mark' => $request->mark,
            //  'exam_date'  => $request->exam_date,
        ]);

        return response()->json([
            'success' => true,
            'data' => $mark,
            'message' => 'ุชูุช ุฅุถุงูุฉ ุงูุนูุงูุฉ ุจูุฌุงุญ',
        ]);
    }




    // ุฌูุจ ุนูุงูุงุช ุงูุทูุงุจ ุญุณุจ ุงูุตู ูุงููุงุฏุฉ


    public function getMarksByClassAndSubject($classId, $subjectId): JsonResponse
    {//  $studentIdู        ->where('student_id', $studentId)    ุดุฑุท ุงูุตู

//        $marks = Mark::with('student') ุฃุญุถุฑ ุฏุงุชุง ุงูุนููุงุช ู ุงูุทุงูุจ  with('student')
//            ->where('the_class_id', $classId)
//            ->where('subject_id', $subjectId)
//            ->get();
//
        $marks = Mark::where('the_class_id', $classId)
            ->where('subject_id', $subjectId)
            ->get();

        if ($marks->isEmpty()) {
            return response()->json([
                'success' => false,
                'message' => 'ูุง ุชูุฌุฏ ุนูุงูุงุช ููุฐู ุงููุงุฏุฉ ูู ูุฐุง ุงูุตู'
            ], 404);
        }

        return response()->json([
            'success' => true,
            'data' => $marks,
            'message' => 'ุชู ุฌูุจ ุงูุนูุงูุงุช ุจูุฌุงุญ'
        ]);
    }

    public function getAllMarksByStudentInClass($studentId, $classId): JsonResponse
    {
        // ุฌูุจ ุงูุนูุงูุงุช ูุน ุจูุงูุงุช ุงูุทุงูุจ ูุงูููุงุฏ
        $marks = Mark::with( 'subject')
            ->where('student_id', $studentId)
            ->where('the_class_id', $classId)
            ->get();

        if ($marks->isEmpty()) {
            return response()->json([
                'success' => false,
                'message' => 'ูุง ุชูุฌุฏ ุนูุงูุงุช ููุฐุง ุงูุทุงูุจ ูู ูุฐุง ุงูุตู'
            ], 404);
        }

        return response()->json([
            'success' => true,
            'data' => $marks,
            'message' => 'ุชู ุฌูุจ ุฌููุน ุนูุงูุงุช ุงูุทุงูุจ ุจูุฌุงุญ'
        ]);
    }


    public function getStudentDetailsByMark($markId): JsonResponse
    {
        $mark = Mark::with('student')->find($markId);

        if (!$mark) {
            return response()->json([
                'success' => false,
                'message' => 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุงูุฉ'
            ], 404);
        }

        return response()->json([
            'success' => true,
            'student' => $mark->student, // ุชูุงุตูู ุงูุทุงูุจ ุงููุฑุชุจุท ุจุงูุนูุงูุฉ
            'mark'    => $mark->mark,
            'message' => 'ุชู ุฌูุจ ุชูุงุตูู ุงูุทุงูุจ ุจูุฌุงุญ'
        ]);
    }

    public function storeWeeklyProgram(Request $request): JsonResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }
        $validated =  $request->validate([
            'director_id' => 'required|exists:directors,id',
            'the_class_id' => 'required|exists:the_classes,id',
            'program_image' => 'required|file|mimes:pdf,jpg,jpeg,png|max:2048', // ูุณูุญ ุจุตูุฑ ู PDF
        ]);
        $formats = ['Y-m-d', 'd-m-Y', 'd/m/Y'];// ูุฐุง ุจุงูุจูุณุชูุงู ููู ูุง ุจุนุชุช ุงูุชุงุฑูุฎ ููุจูู
        foreach ($formats as $format) {
            try {
                $validated['date'] = Carbon::createFromFormat($format, $validated['date'])->format('Y-m-d');
                break;
            } catch (\Exception $e) {
                // ุชุฌุงูู ูุญุงูู ุจุงูุตูุบุฉ ุงูุชุงููุฉ
            }
        }

        // ุฑูุน ุงูุตูุฑุฉ ูุชุฎุฒูููุง
        $imagePath = $request->file('program_image')->store('ุตูุฑ', 'public');
        // ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ
        $program = WeeklyProgram::create([
            'program_image' => $imagePath,
            'director_id' => $request->director_id,
            'the_class_id' => $request->the_class_id,
        ]);
        // ุฑุฌูุน ุงุณุชุฌุงุจุฉ JSON
        return response()->json([
            'success' => true,
            'message' => 'ุชูุช ุฅุถุงูุฉ ุงูุจุฑูุงูุฌ ุงูุฃุณุจูุนู ุจูุฌุงุญ',
            'data' => $program
        ]);
    }
    public function indexWeeklyPrograms(): JsonResponse
    {
        // ุฌูุจ ูู ุงูุจุฑุงูุฌ ูุน ุฑูุงุจุท ุงูุตูุฑ ุงููุงููุฉ
        $programs = WeeklyProgram::all()->map(function($program) {
            $program->program_image_url = asset('storage/' . $program->program_image);
            return $program;
        });

        return response()->json([
            'success' => true,
            'message' => 'ุชู ุฌูุจ ุงูุจุฑุงูุฌ ุงูุฃุณุจูุนูุฉ ุจูุฌุงุญ',
            'data' => $programs
        ]);
    }

    // ุญูุธ ุงูุชููุฏ
    public function store_check(Request $request): \Illuminate\Http\JsonResponse|\Illuminate\Http\RedirectResponse
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        $validated = $request->validate([
            'student_id'  => 'required|exists:students,id',
            'director_id' => 'required|exists:directors,id',
            'date'        => 'required|date',
            'status'      => 'required|in:ุญุงุถุฑ,ุบุงุฆุจ,ูุชุฃุฎุฑ',
        ]);

        $formats = ['Y-m-d', 'd-m-Y', 'd/m/Y'];
        foreach ($formats as $format) {
            try {
                $validated['date'] = \Carbon\Carbon::createFromFormat($format, $validated['date'])->format('Y-m-d');
                break;
            } catch (\Exception $e) {
                // ุชุฌุงูู ูุญุงูู ุจุงูุตูุบุฉ ุงูุชุงููุฉ
            }
        }

        $check = Check::create($validated);

        // ุฅุฐุง ุงูุทูุจ API
        if ($request->wantsJson()) {
            return response()->json([
                'success' => true,
                'message' => 'ุชู ุญูุธ ุงูุชููุฏ ุจูุฌุงุญ',
                'data'    => $check,
            ]);
        }

        // ุฅุฐุง ุงูุทูุจ ูู ุงูููุจ
        return redirect()->route('director.attendance')->with('success', 'โ ุชู ุชุณุฌูู ุงูุชููุฏ ุจูุฌุงุญ');
    }

    public function attendanceForm()
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        // ูู ุงูุทูุงุจ ูุนุฑุถูู ูู ุงูููุฑู
        $students = Student::all();

        return view('director.attendance-create', compact('students'));
    }


    // ุนุฑุถ ุงูุชููุฏ
    public function index_check(Request $request): \Illuminate\Http\JsonResponse|\Illuminate\Contracts\View\View
    {
        if (auth()->user()->role !== 'director') {
            abort(403, 'Unauthorized');
        }

        $query = Check::query();

        if ($request->has('date')) {
            $query->where('date', $request->date);
        }

        if ($request->has('director_id')) {
            $query->where('director_id', $request->director_id);
        }

        $records = $query->get();

        // ุฅุฐุง API (Postman)
        if ($request->wantsJson()) {
            if ($records->isEmpty()) {
                return response()->json([
                    'success' => false,
                    'message' => 'ูุง ููุฌุฏ ุชููุฏ ููุฐู ุงูุตู'
                ], 404);
            }

            return response()->json([
                'success' => true,
                'message' => 'ุชู ุฌูุจ ุงูุชููุฏ ุจูุฌุงุญ',
                'data' => $records
            ]);
        }

        // ุฅุฐุง ููุจ (Blade)
        return view('director.attendance-index', compact('records'));
    }


}
